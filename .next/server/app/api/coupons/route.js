"use strict";(()=>{var e={};e.id=383,e.ids=[383],e.modules={96330:e=>{e.exports=require("@prisma/client")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{e.exports=require("assert")},79428:e=>{e.exports=require("buffer")},55511:e=>{e.exports=require("crypto")},94735:e=>{e.exports=require("events")},81630:e=>{e.exports=require("http")},55591:e=>{e.exports=require("https")},11723:e=>{e.exports=require("querystring")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},84393:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>O,routeModule:()=>v,serverHooks:()=>w,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>g});var a={};t.r(a),t.d(a,{GET:()=>m,POST:()=>y});var n=t(42706),o=t(28203),s=t(45994),i=t(51825),u=t(15716),l=t(84574),c=t(35743),p=t(65287),d=t(74559),f=t(71018);let m=(0,c.Rq)({rateLimiter:p.bO,handler:async e=>{let r=await (0,i.getServerSession)(u.Nh);if(!r?.user?.id)return c.sh.unauthorized();if("ADMIN"!==r.user.role)return c.sh.forbidden("Admin access required");let{searchParams:t}=new URL(e.url),a=t.get("status")||"ACTIVE",n=Math.max(1,parseInt(t.get("page")||"1",10)),o=Math.min(100,Math.max(1,parseInt(t.get("limit")||"10",10))),s=(n-1)*o,p=Date.now(),[d,m]=await Promise.all([l.zR.coupon.findMany({where:{status:a},include:{_count:{select:{orders:!0,userCoupons:!0}}},orderBy:{createdAt:"desc"},skip:s,take:o}),l.zR.coupon.count({where:{status:a}})]),y=Date.now()-p;return f.Ay.dbQuery("coupon.findMany",y,{status:a,page:n,limit:o}),c.sh.success({coupons:d,pagination:{page:n,limit:o,total:m,totalPages:Math.ceil(m/o)}})}}),y=(0,c.Rq)({rateLimiter:p.bO,validator:(0,d.S)(d.j.createCoupon),handler:async e=>{let r=await (0,i.getServerSession)(u.Nh);if(!r?.user?.id)return c.sh.unauthorized();if("ADMIN"!==r.user.role)return c.sh.forbidden("Admin access required");let t=e.validatedData;if("PERCENTAGE"===t.type&&t.value>100)return c.sh.error("Percentage value cannot exceed 100",400);let a=t.code.toUpperCase();if(await l.zR.coupon.findUnique({where:{code:a}}))return c.sh.error("Coupon code already exists",409);let n=Date.now(),o=await l.zR.coupon.create({data:{code:a,name:t.name,description:t.description,type:t.type,value:t.value,minOrderAmount:t.minOrderAmount||null,maxDiscount:t.maxDiscount||null,usageLimit:t.usageLimit||null,userUsageLimit:t.userUsageLimit||null,validFrom:t.validFrom?new Date(t.validFrom):new Date,validUntil:t.validUntil?new Date(t.validUntil):null,status:"ACTIVE"}}),s=Date.now()-n;return f.Ay.dbQuery("coupon.create",s),f.Ay.info("Coupon created",{couponId:o.id,code:o.code,userId:r.user.id}),c.sh.success(o,"Coupon created successfully",201)}}),v=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/coupons/route",pathname:"/api/coupons",filename:"route",bundlePath:"app/api/coupons/route"},resolvedPagePath:"/Users/user/Desktop/RogueApe/work/jabistore/src/app/api/coupons/route.js",nextConfigOutput:"",userland:a}),{workAsyncStorage:h,workUnitAsyncStorage:g,serverHooks:w}=v;function O(){return(0,s.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:g})}},13676:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0})},51825:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0});var a={};Object.defineProperty(r,"default",{enumerable:!0,get:function(){return o.default}});var n=t(13676);Object.keys(n).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(a,e))&&(e in r&&r[e]===n[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return n[e]}}))});var o=function(e,r){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=s(void 0);if(t&&t.has(e))return t.get(e);var a={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&({}).hasOwnProperty.call(e,o)){var i=n?Object.getOwnPropertyDescriptor(e,o):null;i&&(i.get||i.set)?Object.defineProperty(a,o,i):a[o]=e[o]}return a.default=e,t&&t.set(e,a),a}(t(64767));function s(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(s=function(e){return e?t:r})(e)}Object.keys(o).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(a,e))&&(e in r&&r[e]===o[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return o[e]}}))})},15716:(e,r,t)=>{t.d(r,{Nh:()=>a}),t(64767);let a=t(50744).N},50744:(e,r,t)=>{t.d(r,{N:()=>u});var a=t(91642),n=t(28053),o=t(86259),s=t(34926),i=t(84574);let u={adapter:(0,o.y)(i.zR),providers:function(){let e=[(0,a.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){try{if(!e?.email||!e?.password)return console.error("Missing credentials"),null;let r=e.email.toLowerCase().trim(),t=await i.zR.user.findUnique({where:{email:r}});if(!t)return console.error(`User not found: ${r}`),null;if(!t.password)return console.error("User has no password (OAuth account)"),null;if(!await s.Ay.compare(e.password,t.password))return console.error("Invalid password"),null;return{id:t.id,email:t.email,name:t.name,role:t.role,image:t.avatar}}catch(e){return console.error("Authorization error:",e),null}}})];return process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?e.push((0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})):console.warn("Google OAuth not configured: GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET missing"),e}(),pages:{signIn:"/auth/signin"},session:{strategy:"jwt",maxAge:86400,updateAge:3600},jwt:{maxAge:86400},callbacks:{signIn:async({user:e,account:r,profile:t})=>!0,async jwt({token:e,user:r,account:t}){if(r)e.role=r.role||e.role||"USER",e.avatar=r.image||e.avatar||null,e.email=r.email;else if(!e.role&&e.sub)try{let r=await i.zR.user.findUnique({where:{id:e.sub}});r&&(e.role=r.role,e.avatar=r.avatar,e.email=r.email)}catch(e){console.error("Error fetching user for token:",e)}return e},session:async({session:e,token:r})=>(r&&e.user&&(e.user.id=r.sub,e.user.role=r.role||"USER",e.user.image=r.avatar??e.user.image??null,e.user.email=r.email??e.user.email,!e.user.id&&r.sub&&(e.user.id=r.sub)),e)},secret:process.env.NEXTAUTH_SECRET||"dilitech-dev-secret-key-2024",debug:!1}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[5994,5452,4926,126,1978,472],()=>t(84393));module.exports=a})();