exports.id=472,exports.ids=[472],exports.modules={96487:()=>{},78335:()=>{},35743:(e,r,t)=>{"use strict";t.d(r,{Rq:()=>o,sh:()=>s});var a=t(39187),i=t(71018);class s{static success(e,r="Success",t=200){return a.NextResponse.json({success:!0,data:e,message:r,error:null},{status:t})}static error(e,r=400,t=null,s=null){let o={success:!1,data:null,message:String(e||"An error occurred"),error:String(t||e||"An error occurred")};return s&&(Array.isArray(s)?o.details=s:"object"==typeof s&&null!==s?o.details=s:o.details=[s]),i.Ay.error("API Error",Error(e),{status:r,details:s}),a.NextResponse.json(o,{status:r})}static unauthorized(e="Unauthorized"){return this.error(e,401)}static forbidden(e="Forbidden"){return this.error(e,403)}static badRequest(e="Bad request",r=null){return this.error(e,400,"BadRequest",r)}static notFound(e="Resource not found"){return this.error(e,404)}static validationError(e,r="Validation failed"){return this.error(r,400,"ValidationError",e)}static serverError(e="Internal server error",r=null){let t=r?.message||r?.toString()||"InternalServerError",a=r?{name:r.name,code:r.code,meta:r.meta}:null;return this.error(e,500,t,a)}static rateLimitExceeded(e=null){let r=this.error("Too many requests, please try again later.",429);return e&&r.headers.set("Retry-After",e.toString()),r}}function o(e={}){var r,t;let{rateLimiter:a,validator:n,handler:l}=e,u=l;if(n){let e=u;u=async(r,t)=>{let a=await n(r);if(!a.success){let e=[];return a.details&&(e=Array.isArray(a.details)?a.details.filter(e=>null!=e):"object"==typeof a.details?[a.details]:[{path:"",message:String(a.details)}]),s.validationError(e,a.error||"Validation failed")}return r.validatedData=a.data,e(r,t)}}return a&&(r=u,u=async(e,t)=>{let i=await a(e);return i.success?r(e,t):s.rateLimitExceeded(i.retryAfter)}),t=u,u=async(e,r)=>{let a=Date.now(),o=e.method,n=new URL(e.url).pathname;try{let s=await t(e,r),l=Date.now()-a;return i.Ay.apiRequest(o,n,s.status,l),s}catch(e){if(Date.now(),i.Ay.apiError(o,n,e),"ZodError"===e.name&&e.errors&&Array.isArray(e.errors)){let r=e.errors.filter(e=>null!=e).map(e=>({path:e.path&&Array.isArray(e.path)?e.path.join("."):String(e.path||""),message:e.message||"Validation error"}));return s.validationError(r)}if(e.message?.includes("Unauthorized")||e.message?.includes("401"))return s.unauthorized(e.message);if(e.message?.includes("Forbidden")||e.message?.includes("403"))return s.forbidden(e.message);return console.error("API Error Details:",{name:e.name,message:e.message,stack:e.stack,code:e.code,meta:e.meta}),s.serverError(e.message||"An unexpected error occurred",e)}}}},71018:(e,r,t)=>{"use strict";t.d(r,{Ay:()=>s});class a{constructor(){this.logLevel=process.env.LOG_LEVEL||"info"}shouldLog(e){let r={debug:0,info:1,warn:2,error:3};return r[e]>=r[this.logLevel]}formatMessage(e,r,t=null){let a=new Date().toISOString();return(e.toUpperCase(),t)?{timestamp:a,level:e,message:r,data:t}:{timestamp:a,level:e,message:r}}debug(e,r=null){this.shouldLog("debug")}info(e,r=null){this.shouldLog("info")&&console.info(JSON.stringify(this.formatMessage("info",e,r)))}warn(e,r=null){this.shouldLog("warn")&&console.warn(JSON.stringify(this.formatMessage("warn",e,r)))}error(e,r=null,t=null){this.shouldLog("error")&&console.error(JSON.stringify({...this.formatMessage("error",e,t),error:r?{message:r.message,stack:r.stack,name:r.name}:null}))}apiRequest(e,r,t,a,i=null){this.info("API Request",{method:e,path:r,status:t,duration:`${a}ms`,userId:i})}apiError(e,r,t,a=null){this.error("API Error",t,{method:e,path:r,userId:a})}dbQuery(e,r,t=null){}dbError(e,r){this.error("Database Error",r,{query:e.substring(0,100)})}}let i=new a,s=i,{debug:o,info:n,warn:l,error:u,apiRequest:d,apiError:m,dbQuery:c,dbError:p}=i},65287:(e,r,t)=>{"use strict";t.d(r,{$j:()=>n,bO:()=>s,t5:()=>o});let a=new Map;function i(e={}){let{windowMs:r=9e5,max:t=100,message:s="Too many requests, please try again later.",skipSuccessfulRequests:o=!1,skipFailedRequests:n=!1}=e;return async e=>{let i=e.headers.get("x-forwarded-for"),o=e.headers.get("x-real-ip"),n=i?.split(",")[0]||o||"unknown",l=`rate_limit:${n}`,u=Date.now(),d=a.get(l);if(d){if(u<d.resetTime){if(d.count++,d.count>t)return{success:!1,error:s,retryAfter:Math.ceil((d.resetTime-u)/1e3),status:429}}else d.count=1,d.resetTime=u+r}else a.set(l,{count:1,resetTime:u+r});return{success:!0}}}setInterval(()=>{let e=Date.now();for(let[r,t]of a.entries())e-t.resetTime>0&&a.delete(r)},3e5);let s=i({windowMs:9e5,max:100}),o=i({windowMs:9e5,max:5,message:"Too many login attempts, please try again later."}),n=i({windowMs:6e4,max:3,message:"Too many payment attempts, please wait a moment."})},74559:(e,r,t)=>{"use strict";t.d(r,{S:()=>n,j:()=>l});var a=t(12033),i=t(67939),s=t(35755),o=t(71018);function n(e){return async r=>{try{let t;if("GET"===r.method){let e=new URL(r.url);t=Object.fromEntries(e.searchParams.entries())}else{let e=r.headers.get("content-type")||"";if(e.includes("application/json"))t=await r.json();else if(e.includes("application/x-www-form-urlencoded")){let e=await r.formData();t=Object.fromEntries(e.entries())}else t={}}let a=e.parse(t);return{success:!0,data:a}}catch(e){if(e instanceof a.G){o.Ay.warn("Validation error",{errors:e.errors,issues:e.issues,formErrors:e.formErrors});let r=e.issues||e.errors||[],t=Array.isArray(r)&&r.length>0?r.map(e=>({path:e.path&&Array.isArray(e.path)?e.path.join("."):e.path?String(e.path):"root",message:e.message||"Validation error",code:e.code,expected:e.expected,received:e.received})):[{path:"unknown",message:"Validation failed - no error details available"}];return console.error("=== VALIDATOR ERROR DETAILS ==="),console.error("ZodError object:",e),console.error("ZodError.errors:",e.errors),console.error("ZodError.issues:",e.issues),console.error("Processed error details:",t),{success:!1,error:"Validation failed",details:t,status:400}}return o.Ay.error("Validation middleware error",e),{success:!1,error:"Invalid request",status:400}}}}let l={pagination:i.Ik({page:s.ai().int().min(1).default(1).optional(),limit:s.ai().int().min(1).max(100).default(20).optional()}),createProduct:i.Ik({name:i.Yj().min(1,"Product name is required").max(255),slug:i.Yj().min(1,"Slug is required").max(255).regex(/^[a-z0-9-]+$/,"Slug can only contain lowercase letters, numbers, and hyphens"),sku:i.Yj().min(1,"SKU is required").max(100),description:i.Yj().max(5e3).optional().nullable().transform(e=>""===e||void 0===e?null:e),shortDescription:i.Yj().max(160).optional().nullable().transform(e=>""===e||void 0===e?null:e),price:s.ai().positive("Price must be greater than 0"),originalPrice:i.vk(e=>""===e||null==e?null:e,s.ai().positive().nullable().optional()),stock:s.ai().int().min(0).default(0),weight:i.vk(e=>""===e||null==e?null:e,s.ai().positive().nullable().optional()),dimensions:i.Yj().max(100).optional().nullable().transform(e=>""===e||void 0===e?null:e),featured:i.zM().default(!1),published:i.zM().default(!0),categoryId:i.Yj().min(1,"Category is required"),brandId:i.Yj().min(1,"Brand is required"),images:i.YO(i.Ik({url:i.Yj().url("Invalid image URL"),alt:i.Yj().optional(),isPrimary:i.zM().optional()})).optional().default([]),features:i.YO(i.Yj()).optional().default([]),specifications:i.YO(i.Ik({name:i.Yj(),value:i.Yj()})).optional().default([]),seoTitle:i.Yj().min(1,"SEO title is required").max(255),seoDescription:i.Yj().min(1,"SEO description is required").max(160,"SEO description must be 160 characters or less")}),createOrder:i.Ik({items:i.YO(i.Ik({productId:i.Yj().uuid(),quantity:i.ai().int().positive()})).min(1),shippingAddress:i.Ik({firstName:i.Yj().min(1),lastName:i.Yj().min(1),email:i.Yj().email(),phone:i.Yj().min(10),address:i.Yj().min(1),city:i.Yj().min(1),state:i.Yj().optional(),postalCode:i.Yj().optional(),country:i.Yj().min(1)}),paymentMethod:i.k5(["mpesa","card","stripe"]),couponCode:i.Yj().optional()}),mpesaPayment:i.Ik({phone:i.Yj().regex(/^254\d{9}$/,"Phone must be in format 2547XXXXXXXX"),amount:i.ai().positive().optional(),orderId:i.Yj().uuid("Order ID is required")}),createReview:i.Ik({productId:i.Yj().uuid("Invalid product ID"),rating:i.ai().int().min(1,"Rating must be at least 1").max(5,"Rating cannot exceed 5"),title:i.Yj().min(1).max(255).optional(),comment:i.Yj().min(1,"Review comment is required").max(2e3,"Review comment is too long")}),createCoupon:i.Ik({code:i.Yj().min(3,"Coupon code must be at least 3 characters").max(50,"Coupon code is too long").regex(/^[A-Z0-9-_]+$/,"Coupon code can only contain uppercase letters, numbers, hyphens, and underscores").transform(e=>e.toUpperCase()),name:i.Yj().min(1,"Coupon name is required").max(255,"Coupon name is too long"),description:i.Yj().max(500,"Description is too long").optional(),type:i.k5(["PERCENTAGE","FIXED_AMOUNT","FREE_SHIPPING"],{errorMap:()=>({message:"Invalid coupon type"})}),value:s.ai().positive("Value must be positive"),minOrderAmount:i.vk(e=>""===e||null==e?null:e,s.ai().positive("Minimum order amount must be positive").nullable().optional()),maxDiscount:i.vk(e=>""===e||null==e?null:e,s.ai().positive("Maximum discount must be positive").nullable().optional()),usageLimit:i.vk(e=>""===e||null==e?null:e,s.ai().int().positive("Usage limit must be a positive integer").nullable().optional()),userUsageLimit:i.vk(e=>""===e||null==e?null:e,s.ai().int().positive("User usage limit must be a positive integer").nullable().optional()),validFrom:i.vk(e=>{if(e&&""!==e&&null!=e)return e},i.KC([i.Vx(),i.Yj().datetime(),i.Yj().regex(/^\d{4}-\d{2}-\d{2}$/).transform(e=>{let r=new Date(e+"T00:00:00.000Z");if(isNaN(r.getTime()))throw Error("Invalid date format");return r.toISOString()})]).optional()),validUntil:i.KC([i.Yj().datetime(),i.Yj().regex(/^\d{4}-\d{2}-\d{2}$/).transform(e=>{let r=new Date(e+"T00:00:00.000Z");if(isNaN(r.getTime()))throw new a.G([{code:"custom",path:[],message:"Invalid date format"}]);return r.toISOString()}),i.ch()]).optional()}),updateUser:i.Ik({name:i.Yj().min(1).max(255).optional(),email:i.Yj().email().optional(),phone:i.Yj().min(10).optional(),role:i.k5(["USER","ADMIN","MODERATOR"]).optional()})}},84574:(e,r,t)=>{"use strict";t.d(r,{zR:()=>i});var a=t(96330);let i=globalThis.prisma??new a.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}})}};